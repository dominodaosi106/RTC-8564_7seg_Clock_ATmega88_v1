# ATmega88P 7セグメントLEDクロック 取扱説明書

この取扱説明書では、ATmega88Pマイコンを使用した7セグメントLEDクロック（以下、「本クロック」）の操作方法を説明します。本クロックは、時刻（24時間または12時間表示）、年月日の表示・設定が可能なデジタル時計です。2つのスイッチ（S1、S2）を使用して操作します。

---

## 1. 機能概要
- **時刻表示**：通常モードでは、時:分:秒をリアルタイムで表示します。
  - 24時間表示または12時間表示（AM/PM）を切り替え可能。
  - コロン（:）は毎秒点灯し、0.5秒後に消灯します。
- **年月日表示**：年月日（YY.MM.DD形式）を一時的に表示可能。
- **時刻設定**：時、分、秒を個別に設定可能。
- **年月日設定**：年、月、日を個別に設定可能。
- **ブザー機能**：
  - 電源投入時：20msのブザー音（初回または設定異常時は1回、正常起動時は2回）。
  - 毎正時（0時または12時）：100msのブザー音（10ms音+80ms無音+10ms音）。
- **LEDインジケータ**：
  - **LED7**（7セグメントの「G」セグメント）：RTCの電圧低下（VLビット=1）時に常時点灯。12時間表示への切り替え時に2秒間点灯。
  - **LED8**（7セグメントの小数点）：毎秒16ms点灯。
- **自動復帰**：年月日表示や設定モードから一定時間操作がない場合、通常モード（時刻表示）に自動復帰。

---

## 2. 操作方法

### 2.1 スイッチの役割
- **S1（スイッチ1）**：モード切り替え、表示形式変更。
- **S2（スイッチ2）**：値の変更、年月日表示の開始。

### 2.2 通常モード（時刻表示）
- **表示内容**：
  - 6桁の7セグメントLEDに「HH:MM:SS」を表示。
  - 24時間表示の場合：00:00:00～23:59:59。
  - 12時間表示の場合：12:00:00～11:59:59（AM/PMインジケータ点灯）。
- **操作**：
  - **S1短押し**（押してすぐ離す）：24時間表示と12時間表示を切り替え。
    - 12時間表示に切り替えた際、LED7が2秒間点灯。
  - **S2短押し**（押してすぐ離す）：年月日表示モードに移行（2秒間表示）。
  - **S1+S2同時長押し（2秒以上）**：時刻設定モード（時設定）に移行。

### 2.3 年月日表示モード
- **表示内容**：
  - 「YY.MM.DD」形式で年月日を表示（例：2025年6月9日は「25.06.09」）。
  - 小数点（LED8）は年と月の間、月と日の間に点灯。
- **操作**：
  - **自動復帰**：2秒後に自動的に通常モードに戻る。
  - **S2長押し（2秒以上）**：年月日設定モード（年設定）に移行。
- **注意**：S1を押しても反応しません。

### 2.4 時刻設定モード
- **モードの流れ**：時設定 → 分設定 → 秒設定 → 保存 → 通常モード
- **表示内容**：
  - 設定中の桁（時：2桁、分：2桁、秒：2桁）が点滅（4Hz）。
  - 設定中の値は24時間形式で表示（例：時設定中は0～23）。
- **操作**：
  - **S1短押し**：次の設定項目（時→分→秒→保存）に進む。
  - **S2短押し**：設定中の値を1つ増加（例：時なら0～23、分数なら0～59）。
  - **S2長押し（0.5秒以上）**：設定中の値を10Hz（0.1秒間隔）で自動増加。
  - **保存モード**（S1押下で移行）：S1を押すと設定をRTCに保存し、通常モードに復帰。
- **注意**：
  - スイッチを押した後、離すまで次の操作は無効（デバウンス処理）。
  - S2長押し中は点滅が停止し、値が連続増加。

### 2.5 年月日設定モード
- **モードの流れ**：年設定 → 月設定 → 日設定 → 保存 → 通常モード
- **表示内容**：
  - 「YY.MM.DD」形式で表示。
  - 設定中の桁（年：2桁、月：2桁、日：2桁）が点滅（4Hz）。
- **操作**：
  - **S1短押し**：次の設定項目（年→月→日→保存）に進む。
  - **S2短押し**：設定中の値を1つ増加（年：0～99、月：1～12、日：1～31）。
  - **S2長押し（0.5秒以上）**：設定中の値を10Hz（0.1秒間隔）で自動増加。
  - **保存モード**（S1押下で移行）：S1を押すと設定をRTCに保存し、通常モードに復帰。
- **注意**：
  - スイッチを押した後、離すまで次の操作は無効。
  - S2長押し中は点滅が停止。

### 2.6 ブザーとLEDの動作
- **ブザー**：
  - 電源投入時：20msのブザー音（初回/異常時：1回、正常時：2回）。
  - 毎正時（0時/12時）：100msのブザー音（10ms音+80ms無音+10ms音）。
- **LED7**：
  - RTC電圧低下（VLビット=1）時：常時点灯（時刻・年月日がリセットされている可能性）。
  - 12時間表示への切り替え時：2秒間点灯。
- **LED8**（小数点）：毎秒16ms点灯。
- **コロン**：通常モードまたは時刻設定モードで毎秒0.5秒間点灯。

---

## 3. 注意事項
- **電源投入時の初期化**：
  - RTCの電圧低下（VLビット=1）が検出された場合、時刻は00:00:00、年月日は2025.01.01にリセットされ、LED7が常時点灯。
  - RTCの設定が異常（レジスタ0x0Dが不正）の場合、初期化を行いブザーが20ms鳴動。
- **範囲制限**：
  - 時刻：時（0～23）、分（0～59）、秒（0～59）。
  - 年月日：年（0～99）、月（1～12）、日（1～31）。
  - 範囲外の値は自動補正（例：時24→0、月13→1）。
- **操作のタイミング**：
  - スイッチ操作後、約100μsのデバウンス時間が必要。
  - 長押し操作は0.5秒以上で有効、自動増加は0.1秒間隔。
- **年月日の精度**：
  - 日付の妥当性（例：2月30日など）はチェックされません。適切な値を設定してください。

---

## 4. 仕様
- **マイコン**：ATmega88P
- **RTC**：RTC-8564（I2C接続、1Hz割り込み）
- **表示**：6桁7セグメントLED（時:分:秒または年.月.日）
- **スイッチ**：S1（PC2）、S2（PC3）
- **ブザー**：約4kHz、PD6経由で制御
- **クロック**：1MHz（内部発振器）
- **タイマー**：
  - Timer1：1ms周期（スイッチ読み取り、点滅制御）
  - Timer2：約1kHz（7セグメント多重化）
- **割り込み**：
  - INT0：RTCの1Hz信号で時刻更新
  - Timer1/2：表示と制御用

---

## 5. トラブルシューティング
- **時刻がリセットされる/LED7が常時点灯**：
  - RTCのバックアップ電池電圧が低下。電池を交換し、時刻・年月日を再設定してください。
- **ブザーが鳴らない**：
  - ブザー回路（PD6）を確認。電源投入時や正時に鳴らない場合、配線やブザー自体の故障を疑ってください。
- **表示が乱れる**：
  - 7セグメントLEDの配線（PORTB、PORTC、PORTD）を確認。
  - 多重化タイミングが異常の場合、Timer2設定（約1kHz）を確認。
- **スイッチが反応しない**：
  - デバウンス時間（100μs）を考慮し、ゆっくり押してください。
  - 配線（PC2、PC3）を確認。

---

## 6. 操作例
**例1：時刻を15:30:00に設定**
1. 通常モードでS1+S2を2秒以上同時押し → 時設定モード（「15:30:00」、時が点滅）。
2. S2を短押し/長押しして時を「15」に調整。
3. S1を押して分設定モードへ（分が点滅）。
4. S2で分を「30」に調整。
5. S1を押して秒設定モードへ（秒が点滅）。
6. S2で秒を「00」に調整。
7. S1を押して保存モードへ → もう一度S1で保存し通常モードに復帰。

**例2：年月日を2025.06.09に設定**
1. 通常モードでS2を短押し → 年月日表示モード（「25.06.09」）。
2. S2を2秒以上長押し → 年設定モード（年が点滅）。
3. S2で年を「25」に調整。
4. S1を押して月設定モードへ（月が点滅）。
5. S2で月を「06」に調整。
6. S1を押して日設定モードへ（日が点滅）。
7. S2で日を「09」に調整。
8. S1を押して保存モードへ → もう一度S1で保存し通常モードに復帰。

**例3：24時間表示を12時間表示に変更**
1. 通常モードでS1を短押し → 12時間表示に切り替え（例：「15:30:00」→「03:30:00 PM」）。
2. LED7が2秒間点灯。

---

この取扱説明書を参考に、本クロックを正しくご使用ください。ご不明な点は、サポートまでお問い合わせください。